<!-- build time:Tue Jul 10 2018 10:02:26 GMT+0800 (CST) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="boxi"><meta name="google-site-verification" content="iOm73y6vS5qme_s6tWGOVE1l5iATBiNi7Ye7J4dv68g"><meta name="baidu-site-verification" content="9BXA7j00i6"><title>所见即所得，可视化爬虫实践 · boxi's box</title><meta name="description" content="前段时间工作上有个需求要爬取东南亚各个国家热门音乐站点的榜单内容，并与K歌内的伴奏素材进行匹配与补充，以此优化用户素材的投放效果。由于音乐站点数量很多，需要分配多个人力执行爬取工作，造成了资源浪费。后在leader的建议下，思考是否能够以一种可配置的方式进行数据爬取，减少一些重复劳动和人力消耗。基于"><meta name="keywords" content="技术积累, 生活感悟"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/img/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/img/logo@2x.png" style="width:150px"><h3><a href="/">boxi's box</a></h3><div class="description"><p>Poor Guy In Shenzhen</p></div></div></div><ul class="social-links"><li><a href="http://weibo.com/2263667870"><i class="fa fa-weibo"></i></a></li><li><a href="http://facebook.com/boxi.zeng"><i class="fa fa-facebook"></i></a></li><li><a href="http://github.com/boxizen"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me">CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben </a><span>Edit by</span><a href="https://github.com/boxizen"> Boxi</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/archives">归档</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"></a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>所见即所得，可视化爬虫实践</a></h3></div><div class="post-content"><blockquote><p>前段时间工作上有个需求要爬取东南亚各个国家热门音乐站点的榜单内容，并与K歌内的伴奏素材进行匹配与补充，以此优化用户素材的投放效果。由于音乐站点数量很多，需要分配多个人力执行爬取工作，造成了资源浪费。后在leader的建议下，思考是否能够以一种可配置的方式进行数据爬取，减少一些重复劳动和人力消耗。基于上述原因本人开展了在这项工作上的一些实践。</p></blockquote><p><img src="/img/posts/spider/1512641660_16_w1368_h538.jpeg" alt="可视化爬虫"></p><h3 id="业界产品"><a href="#业界产品" class="headerlink" title="业界产品"></a>业界产品</h3><p>在跟leader沟通过后，首先在百度和知乎搜了搜看看业界是否已经有了这样的方案或产品，搜索结果发现国内被提及最多的是一个叫 <strong>八爪鱼</strong> 和另一个叫 <strong>集搜客</strong> 的平台，八爪鱼看了一下要收费才能使用，遂放弃。而当打开集搜客的官网，有种牛皮藓广告的既视感，顿时也没有欲望继续操作。不过他们的实现原理还是可以了解一下的，经过粗略地观察，发现需要使用人员手写 <strong>正则</strong> 或 <strong>xpath</strong> 的方式制定爬取规则，有一定的使用门槛，并不是我想要的。</p><p>基于 <strong>可视化</strong> 和 <strong>易用性</strong> 两个主要的目的，又Google了一番，结果找到了一款基于 <strong>scrapy</strong> 实现的可视化爬虫工具 <strong>Portia</strong>，正是预期中样子。</p><p><img src="/img/posts/spider/1512641116_96_w1439_h714.jpeg" alt="可视化爬虫"></p><h3 id="可视化操作"><a href="#可视化操作" class="headerlink" title="可视化操作"></a>可视化操作</h3><p>为了后续的定制化和扩展工作可以更方便易行，本人借鉴 <strong>Portia</strong> 实现一套基于 <strong>Node.js</strong> 的所见即所得爬虫系统。</p><p>开展这项工作第一步是给用户提供可视化的操作，手动点击选择想要爬取的元素。这里的实现方式是通过 <strong>iframe</strong> 加载需要爬取的链接，利用 <strong>javascript</strong> 监听 <strong>iframe</strong> 中的 <strong>mouseover</strong> 与 <strong>mouseout</strong> 等事件，以此实现元素审查监听( <strong>xpath</strong> 和内容)，为此简单写了一个js库 - <strong>inspector.js</strong>，效果如下图：</p><p><img src="/img/posts/spider/1512641248_81_w1304_h928.gif" alt="可视化爬虫"></p><p>但这里有个问题是，由于浏览器同源策略的影响，对于 <strong>iframe</strong> 加载不同域网页的情况而言，实际上父页面 <strong>js</strong> 不能操作 <strong>iframe</strong> 中的页面元素，会出现下图中所示的错误，这里就需要考虑把加载的网页转换为同域下的页面。</p><p><img src="/img/posts/spider/1512641273_59_w1598_h138.jpeg" alt="可视化爬虫"></p><p>看了 <strong>Portia</strong> 的做法，它把加载网页代理到自己的服务器上访问，网页中所有资源引用也全部挂载到自己的域下，猜想是使用类似 <strong>nginx</strong> 代理静态资源的方式实现。有了这个思路后，我也采取了类似的方法，利用服务器代理访问链接，这里本人在 <strong>node</strong> 端使用 <strong>PhantomJS</strong> 加载访问链接，再在加载完毕后直接返回页面到浏览器端。</p><div class="tip"><br>为了防止访问站点本身js造成页面阻塞的情况，在返回页面前已将script标签全部移除，同时为确保页面本身的一些行为不会对元素审查过程中造成影响，还需要在iframe中加入sandbox属性:<br></div><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;iframe id=<span class="string">"xFrame"</span> </span><br><span class="line">  sandbox=<span class="string">"allow-same-origin allow-scripts"</span> </span><br><span class="line">  onload=<span class="string">"xFrameLoad()"</span>&gt;</span><br><span class="line">&lt;<span class="regexp">/iframe&gt;</span></span><br></pre></td></tr></table></figure><h3 id="信息爬取"><a href="#信息爬取" class="headerlink" title="信息爬取"></a>信息爬取</h3><p>经过上面用户的一系列可视化操作流程后，已经可以获取得到用户配置的爬取字段信息（字段类型、选择器和其他信息），保存至后台后，我们就可以根据站点入口、字段的类型和对应的选择器获取得到想要的数据。</p><p>对于直出的页面，可以简单地通过 <em>request(url,[callback])</em> 的方式输出页面数据，再从里面提取目标数据。但这种方式对js生成的页面并不起作用。所以后台还是使用了headless浏览器 - PhantomJS统一加载入口页面，并在返回的html中通过cheerio执行数据的筛选和提取，核心代码如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> instance = <span class="keyword">await</span> phantom.create();</span><br><span class="line"><span class="keyword">const</span> page = <span class="keyword">await</span> instance.createPage();</span><br><span class="line"><span class="keyword">const</span> status = <span class="keyword">await</span> page.open(url);</span><br><span class="line"><span class="keyword">const</span> html = <span class="keyword">await</span> page.property(<span class="string">'content'</span>);</span><br><span class="line"><span class="keyword">let</span> $ = cheerio.load(html);</span><br></pre></td></tr></table></figure><div class="tip"><br>有些站点页面的图片资源会在拖动滚动条到可视区域才会加载，这就需要在phantom中模拟滚动条拖动的行为，否则不能正常获取得到想要的图片资源：<br></div><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> page.property(<span class="string">'scrollPosition'</span>, &#123;</span><br><span class="line">  top: <span class="number">10000</span>,</span><br><span class="line">  left: <span class="number">0</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="运行效果"><a href="#运行效果" class="headerlink" title="运行效果"></a>运行效果</h3><iframe id="iframe" src="//player.bilibili.com/player.html?aid=25934006&cid=44379374&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen></iframe><p>PS: 家里网速有点慢，loading时间比较长</p></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2017-12-07</span><i class="fa fa-tag"></i><a class="tag" href="/categories/自动化/" title="自动化">自动化 </a><a class="tag" href="/tags/爬虫/" title="爬虫">爬虫</a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,https://boxizen.github.io/2017/12/07/spider/,boxi's box,所见即所得，可视化爬虫实践,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2018/07/07/kube_lego/" title="管理系统配置化实践">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2017/08/22/vue_erp/" title="Vue 浅析与实践">下一篇</a></li></ul></div><a id="comments"></a><div id="vcomments" style="margin:0 30px"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/gh/xcss/valine@v1.1.7/dist/Valine.min.js?v=undefined"></script><script>var valine=new Valine({el:"#vcomments",notify:!0,verify:!1,app_id:"bUTfY8SwOBitSS8uqiV0vG0I-gzGzoHsz",app_key:"N6bRxFzuVXEBBdX96fGb1i4e",placeholder:"来，一起快活",path:window.location.pathname,avatar:"monsterid"})</script></div></div></div></div><script src="https://cdn.bootcss.com/jquery/1.9.0/jquery.min.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script type="text/javascript">var cnzz_protocol="https:"==document.location.protocol?" https://":" http://";document.write(unescape("%3Cspan id='cnzz_stat_icon_1274080808'%3E%3C/span%3E%3Cscript src='"+cnzz_protocol+"s13.cnzz.com/z_stat.php%3Fid%3D1274080808%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"))</script><script type="text/javascript">var ifm=document.getElementById("iframe");ifm&&($(window).width()>500?ifm.height=document.documentElement.clientHeight-250||400:ifm.height=200)</script></body></html><!-- rebuild by neat -->